package com.example.bookfair.config;

import com.example.bookfair.user.model.Stall;
import com.example.bookfair.user.repository.StallRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;

@Component
public class StallDataInitializer implements CommandLineRunner {

    @Autowired
    private StallRepository stallRepository;

    @Override
    public void run(String... args) throws Exception {
        // Only initialize if database is empty
        if (stallRepository.count() == 0) {
            initializeStalls();
        } else if (stallRepository.count() < 436) {
            // If we have fewer than 436 stalls, add the missing ones
            addMissingStalls();
        }
    }

    private void initializeStalls() {
        // Array of polygon coordinates (first point of each polygon) for all 436 polygons
        // Format: {x, y}
        int[][] polygonCoordinates = {
            {1736, 925}, {1736, 884}, {1736, 769}, {1736, 722}, {1355, 729}, {1326, 756}, {1295, 788}, {1263, 819},
            {1389, 820}, {1323, 883}, {1199, 722}, {1230, 688}, {1260, 656}, {1291, 626}, {1322, 567}, {1322, 567},
            {1413, 569}, {1517, 594}, {1547, 627}, {1579, 656}, {1578, 720}, {1592, 753}, {1591, 796}, {1547, 753},
            {1517, 721}, {1488, 689}, {1458, 657}, {1413, 610}, {1322, 658}, {1289, 688}, {1259, 721}, {1228, 755},
            {1187, 801}, {1143, 756}, {1185, 892}, {1230, 894}, {1168, 955}, {1230, 954}, {1291, 954}, {1320, 986},
            {1197, 986}, {1229, 1018}, {1258, 1050}, {1322, 1035}, {1320, 986}, {1322, 1035}, {1406, 1035}, {1406, 986},
            {1406, 986}, {1545, 842}, {1679, 904}, {1679, 853}, {1681, 768}, {1681, 724}, {1662, 683}, {1631, 650},
            {1603, 620}, {1571, 587}, {1539, 556}, {1507, 524}, {1466, 477}, {1423, 477}, {1312, 523}, {1267, 524},
            {1237, 556}, {1207, 587}, {1176, 618}, {1144, 649}, {1084, 649}, {1098, 724}, {1098, 767}, {1098, 813},
            {1098, 856}, {1098, 902}, {1098, 943}, {1130, 980}, {1160, 1011}, {1191, 1045}, {1224, 1077}, {1250, 1106},
            {1291, 1123}, {1335, 1123}, {1380, 1123}, {1421, 1123}, {1464, 1168}, {1562, 1064}, {1967, 883}, {2031, 750},
            {2065, 718}, {2095, 689}, {2155, 751}, {2094, 750}, {2061, 783}, {2032, 811}, {2004, 783}, {2091, 875},
            {2124, 840}, {2154, 812}, {2184, 777}, {2217, 745}, {2248, 777}, {2215, 811}, {2183, 840}, {2153, 875},
            {2121, 904}, {2029, 934}, {2242, 1033}, {2242, 970}, {2244, 905}, {2272, 875}, {2336, 938}, {2274, 938},
            {2242, 970}, {2214, 1002}, {2145, 1070}, {2145, 1070}, {2189, 1070}, {2298, 1085}, {2298, 1022}, {2327, 991},
            {2359, 959}, {2373, 930}, {2373, 884}, {2373, 840}, {2373, 795}, {2355, 760}, {2326, 727}, {2265, 667},
            {2235, 609}, {2191, 609}, {2147, 609}, {2102, 609}, {2043, 634}, {2012, 666}, {1982, 697}, {1965, 837},
            {1870, 748}, {1870, 795}, {1870, 882}, {1870, 927}, {2079, 2034}, {2103, 1979}, {2142, 1979}, {2180, 1979},
            {2213, 1979}, {2248, 1979}, {2248, 1934}, {2213, 1934}, {2180, 1934}, {2142, 1934}, {2103, 1934}, {2118, 1869},
            {2154, 1870}, {2189, 1872}, {2227, 1872}, {2263, 1872}, {2263, 1831}, {2227, 1831}, {2189, 1831}, {2154, 1831},
            {2118, 1831}, {2104, 1762}, {2142, 1762}, {2177, 1763}, {2211, 1763}, {2251, 1763}, {2251, 1722}, {2211, 1722},
            {2177, 1722}, {2142, 1722}, {2104, 1722}, {2279, 1627}, {2241, 1627}, {2196, 1627}, {2161, 1627}, {2117, 1627},
            {1310, 1641}, {1427, 1836}, {1427, 1877}, {1427, 1920}, {1384, 1920}, {1384, 1877}, {1384, 1836}, {1310, 1836},
            {1310, 1879}, {1310, 1917}, {1310, 1962}, {1358, 2010}, {1399, 2010}, {1434, 2010}, {1496, 2363}, {1496, 2383},
            {1496, 2401}, {1496, 2418}, {1496, 2437}, {1496, 2458}, {1496, 2493}, {1496, 2511}, {1496, 2534}, {1496, 2554},
            {1496, 2572}, {1496, 2590}, {1511, 2629}, {1487, 2629}, {1460, 2629}, {1470, 2590}, {1470, 2572}, {1470, 2554},
            {1470, 2534}, {1470, 2511}, {1470, 2493}, {1470, 2458}, {1470, 2437}, {1470, 2418}, {1470, 2401}, {1470, 2383},
            {1470, 2363}, {1400, 2340}, {1400, 2363}, {1400, 2383}, {1400, 2402}, {1400, 2420}, {1400, 2439}, {1400, 2458},
            {1400, 2478}, {1400, 2497}, {1400, 2533}, {1400, 2552}, {1400, 2570}, {1400, 2593}, {1400, 2613}, {1400, 2630},
            {1400, 2649}, {1400, 2667}, {1407, 2705}, {1383, 2705}, {1357, 2705}, {1374, 2667}, {1374, 2649}, {1374, 2630},
            {1374, 2613}, {1374, 2593}, {1374, 2570}, {1374, 2552}, {1374, 2533}, {1374, 2497}, {1374, 2478}, {1374, 2458},
            {1374, 2439}, {1374, 2420}, {1374, 2402}, {1374, 2383}, {1374, 2363}, {1374, 2340}, {1290, 2457}, {1290, 2477},
            {1290, 2495}, {1290, 2515}, {1290, 2534}, {1290, 2554}, {1290, 2589}, {1290, 2608}, {1290, 2628}, {1290, 2646},
            {1290, 2666}, {1267, 2666}, {1267, 2646}, {1267, 2628}, {1267, 2608}, {1267, 2589}, {1267, 2554}, {1267, 2534},
            {1267, 2515}, {1267, 2495}, {1267, 2477}, {1267, 2457}, {1220, 2455}, {1220, 2474}, {1220, 2494}, {1220, 2512},
            {1220, 2533}, {1220, 2552}, {1220, 2589}, {1220, 2608}, {1220, 2627}, {1220, 2645}, {1220, 2667}, {1311, 2706},
            {1284, 2706}, {1258, 2706}, {1235, 2706}, {1211, 2706}, {1184, 2706}, {1194, 2667}, {1194, 2645}, {1194, 2627},
            {1194, 2608}, {1194, 2589}, {1194, 2552}, {1194, 2533}, {1194, 2512}, {1194, 2494}, {1194, 2474}, {1194, 2455},
            {824, 2084}, {824, 2048}, {824, 2013}, {824, 1978}, {824, 1941}, {824, 1906}, {824, 1871}, {824, 1838},
            {824, 1799}, {824, 1764}, {824, 1731}, {824, 1694}, {824, 1661}, {824, 1621}, {824, 1588}, {824, 1554},
            {894, 1553}, {894, 1588}, {894, 1621}, {894, 1661}, {894, 1694}, {894, 1731}, {894, 1764}, {894, 1799},
            {894, 1838}, {894, 1871}, {894, 1906}, {894, 1941}, {894, 1978}, {894, 2013}, {894, 2048}, {894, 2084},
            {895, 2135}, {730, 2135}, {731, 2092}, {731, 2059}, {731, 2021}, {731, 1987}, {731, 1955}, {731, 1920},
            {731, 1889}, {731, 1854}, {731, 1822}, {731, 1787}, {731, 1755}, {731, 1723}, {731, 1693}, {731, 1656},
            {731, 1621}, {731, 1591}, {731, 1553}, {730, 1500}, {773, 1500}, {811, 1500}, {937, 1500}, {977, 1500},
            {1019, 1500}, {1016, 1553}, {1016, 1586}, {1016, 1623}, {1016, 1655}, {1016, 1685}, {1016, 1718}, {1016, 1753},
            {1016, 1785}, {1016, 1820}, {1016, 1852}, {1016, 1887}, {1016, 1920}, {1016, 1954}, {1016, 1986}, {1016, 2019},
            {1016, 2054}, {490, 1675}, {490, 1711}, {490, 1748}, {490, 1788}, {490, 1828}, {490, 1868}, {490, 1907},
            {490, 1944}, {490, 1983}, {573, 1988}, {573, 1948}, {573, 1910}, {573, 1869}, {573, 1832}, {573, 1792},
            {573, 1756}, {573, 1713}, {573, 1678}, {573, 1637}, {410, 2058}, {414, 1988}, {414, 1951}, {414, 1911},
            {414, 1871}, {414, 1831}, {414, 1794}, {414, 1753}, {414, 1713}, {414, 1678}, {414, 1637}, {186, 1607},
            {570, 796}, {354, 793}, {41, 201}, {26, 391}, {930, 368}, {879, 368}, {821, 368}, {767, 368}, {713, 368},
            {658, 368}, {606, 368}, {553, 368}, {930, 317}, {879, 317}, {821, 317}, {767, 317}, {713, 317}, {658, 317},
            {606, 317}, {553, 317}, {930, 235}, {878, 235}, {825, 235}, {769, 235}, {715, 235}, {663, 235}, {605, 235},
            {553, 235}
        };

        String[] sizes = {"SMALL", "MEDIUM", "LARGE"};
        
        // Generate stall names (A-Z, then AA-AZ, BA-BZ, etc., or use S1, S2, etc.)
        int stallIndex = 0;
        for (int i = 0; i < polygonCoordinates.length; i++) {
            int[] coords = polygonCoordinates[i];
            
            String size = sizes[stallIndex % 3]; // Rotate sizes
            String name = generateStallName(stallIndex);
            
            Stall stall = new Stall();
            stall.setName(name);
            stall.setSize(size);
            stall.setReserved(false);
            stall.setX(coords[0]);
            stall.setY(coords[1]);
            
            stallRepository.save(stall);
            stallIndex++;
        }
        
        System.out.println("Initialized " + stallIndex + " stalls");
    }

    private void addMissingStalls() {
        long existingCount = stallRepository.count();
        int totalStalls = 436;
        int missingCount = totalStalls - (int)existingCount;
        
        if (missingCount <= 0) return;
        
        String[] sizes = {"SMALL", "MEDIUM", "LARGE"};
        
        // Generate coordinates for missing stalls (approximate positions)
        int startIndex = (int)existingCount;
        for (int i = 0; i < missingCount; i++) {
            int stallIndex = startIndex + i;
            String size = sizes[stallIndex % 3];
            String name = generateStallName(stallIndex);
            
            // Calculate approximate position based on index
            int x = 100 + (stallIndex * 10) % 2500;
            int y = 100 + (stallIndex * 15) % 2800;
            
            Stall stall = new Stall();
            stall.setName(name);
            stall.setSize(size);
            stall.setReserved(false);
            stall.setX(x);
            stall.setY(y);
            
            stallRepository.save(stall);
        }
        
        System.out.println("Added " + missingCount + " missing stalls");
    }

    private String generateStallName(int index) {
        // Generate names: A-Z (0-25), AA-AZ (26-51), BA-BZ (52-77), etc.
        if (index < 26) {
            return String.valueOf((char)('A' + index));
        } else {
            int firstLetterIndex = (index - 26) / 26;
            int secondLetterIndex = (index - 26) % 26;
            if (firstLetterIndex < 26) {
                char firstLetter = (char)('A' + firstLetterIndex);
                char secondLetter = (char)('A' + secondLetterIndex);
                return String.valueOf(firstLetter) + String.valueOf(secondLetter);
            } else {
                // For indices > 26*26+26, use S1, S2, etc.
                return "S" + (index + 1);
            }
        }
    }
}
